{% load static %}
{% load i18n %}
{% load humanize %}


<div id="product-detail-div" class="container-xxl mb-3">
  <div class="row g-3">

    <!--Details of Products, ADD to CARD, ADD to WISHLIST-->
    <div class="col-md-5 ps-3 col-lg-5 order-md-last p-0 order-1">
      <div class="d-grid gap-2">
        <div>
          <p class="h4">
            {% if LANGUAGE_CODE == "tk" %}
            {{product.title}}
            {% elif LANGUAGE_CODE == "en" %}
            {{product.title_en}}
            {% else %}
            {{product.title_ru}}
            {% endif %}
          </p>
          <p>Model: <span>{{product.model}}</span></p>
          <p class="fw-bold">{% trans "Product Specifications" %}:</p> 
          <p class="">
              {% if LANGUAGE_CODE == "tk" %}
              {{product.description|linebreaksbr }}
              {% elif LANGUAGE_CODE == "en" %}
              {{product.description_en|linebreaksbr }}
              {% else %}
              {{product.description_ru|linebreaksbr }}
              {% endif %}
            </p>
        </div>

        <div class="d-flex d-flex-inline justify-content-between">
            <div class="price-wrap mt-1 h3">
                <span class="price">{{product.sale_price}} TMT</span>
                {% if product.on_sale %}
                <del class="price-old">${{product.price}}</del>
                {% endif %}
            </div>
        </div>
        <hr>

          <!--CART BUTTONS-->
          <button type="button" id="add-btn" class="btn btn-evvoli-add col-lg-6 fw500 rounded-5" data-url='{% url "orders:add_to_cart" slug=product.slug %}' data-cart-qty='{{ request.session.cart_qty|default:0 }}' data-product-qty='{{ product_qty_in_cart|default:0 }}'>
            Add to Cart
          </button>
          <div id="d-none-div" 
          class="d-flex col-lg-6 align-items-center justify-content-around btn-evvoli-pink rounded-5">
            <p id="d-none-minus-btn" class="my-2 pointer-cursor" data-url='{% url "orders:remove_from_cart" slug=product.slug %}'><i class="fa-solid fa-minus"></i></p>
            <p id="d-none-product-qty" class="my-2">{{ product_qty_in_cart|default:0  }}</p>
            <p id="d-none-plus-btn" class="my-2 pointer-cursor" data-url='{% url "orders:add_to_cart" slug=product.slug %}'><i class="fa-solid fa-plus"></i></p> 
          </div>
          <!--END OF CART BUTTONS-->

      </div>
    </div>
    <!--END OF Details of Products, ADD to CARD, ADD to WISHLIST-->


    <!--Product Images-->
    <div class="col-md-7 col-lg-7 p-0">
      <div class="card mb-3 border-0 text-center">
        <div class="row g-0">
          <div class="col-md-12">

            <div class="card-body p-1">
              <h1 class="mb-0 h2 pe-4 pb-4">
                {% if LANGUAGE_CODE == "tk" %}
                {{product.title}}
                {% elif LANGUAGE_CODE == "en" %}
                {{product.title_en}}
                {% else %}
                {{product.title_ru}}
                {% endif %}
              </h1>
              <div class="text-center">

                <img id="product-main-image" class="image-fluid mx-auto d-block" alt="Responsive image" src="{{ product.image.url}}"
                  alt="{{ product.title }}">
               
                {% for image in product.images.all %}
                <img id="{{image.id}}" class="other-images img-fluid d-block-inline pt-3" width="100px" alt="Responsive image"
                  src="{{ image.thumbnail.url }}" alt="{{ image.image.alt_text }}" 
                  hx-get="{% url "products:product_main_image" category_slug=product.category.slug slug=product.slug %}?product_id={{ product.id }}&image_id={{image.id}}"
                  hx-trigger="click"
                  hx-target="#product-main-image"
                  hx-swap="outerHTML">
                {% endfor %}
                <img id="{{image.id}}" class="other-images img-fluid d-block-inline pt-3" width="100px" alt="Responsive image"
                src="{{ product.image.url}}" alt="{{ product.title}}" 
                  hx-get="{% url "products:product_main_image" category_slug=product.category.slug slug=product.slug %}?product_id={{ product.id }}"
                  hx-trigger="click"
                  hx-target="#product-main-image"
                  hx-swap="outerHTML">
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>
    <!--END OF Product Images-->
  </div>

  <script type="text/javascript">
      // console.log("cart_asyn_post.js")
      console.log("window.addEventListener")

      var navCart = document.querySelector('#cart-qty');
      console.log("navCart =", navCart);

      var addBtn = document.querySelector('#add-btn');
      var minusBtn = document.querySelector('#d-none-minus-btn');
      var plusBtn = document.querySelector('#d-none-plus-btn');
      var qtyDisplay = document.querySelector(`#d-none-product-qty`);
      var dNoneDiv = document.querySelector('#d-none-div');

      var addURL = addBtn.dataset.url;
      var removeURL = minusBtn.dataset.url;

      var productQty = addBtn.dataset.productQty;
      var cartQty = addBtn.dataset.cartQty;

      // console.log(addURL, removeURL)
      // console.log("cartQty =", cartQty, "productQty =", productQty)

      // Function to update the display and button visibility
      var updateDisplay = (qty) => {
          // console.log("qty =", qty)
          if (qty > 0) {
              addBtn.classList.add('d-none');
              dNoneDiv.classList.remove('d-none');
              qtyDisplay.textContent = qty;
          } else {
              addBtn.classList.remove('d-none');
              dNoneDiv.classList.add('d-none');
          }
      };

      var updateNavCart = (qty) => {
          navCart.textContent = qty;
      };

      // Initial update
      updateDisplay(productQty);

      // Add to cart function
      var addToCart = async () => {
          try {
              const response = await fetch(addURL, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                      'X-CSRFToken': '{{ csrf_token }}'
                  }
              });

              if(response.ok) {
                  console.log(response.json)
                  const jsonData = await response.json();
                  updateDisplay(jsonData.productQty);
                  updateNavCart(jsonData.cartQty);
              } else {
                  console.log(response.json)
                  console.error('Failed to add item to cart');
              }
          } catch (error) {
              console.error('Failed to connect to server', error);
          }
      };

      // Remove from cart function
      var removeFromCart = async () => {
          try {
              const response = await fetch(removeURL, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                      'X-CSRFToken': '{{ csrf_token }}'
                  }
              });
              if(response.ok) {
                  console.log(response.json)
                  const jsonData = await response.json();
                  updateDisplay(jsonData.productQty);
                  updateNavCart(jsonData.cartQty);
              } else {
                  console.log(response.json)
                  console.error('Failed to add item to cart');
              }
          } catch (error) {
              console.error('Failed to connect to server', error);
          }  
      };

      // Event handlers
      addBtn.addEventListener('click', addToCart);
      minusBtn.addEventListener('click', removeFromCart);
      plusBtn.addEventListener('click', addToCart);

      console.log("END OF SCRIPT")
  </script>

