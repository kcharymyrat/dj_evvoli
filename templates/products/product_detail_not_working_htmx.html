{% extends 'base.html' %}

{% load static %}
{% load i18n %}


{% block title %}
{% if product %}{{ product.title }}{% else %}{% trans "Önüm" %}{% endif %}
{% endblock %}
{% block content %}

<div id="product-detail-div" class="container-xxl">
{% if messages %}
<div class="alert alert-warning" alert="{{ message.tags }}" role="alert">
{% for message in messages  %}
  {{message|safe}} - <a href="#" class="alert-link">Your Wishlist</a>.
{% endfor %}
</div>
{% endif %}
  <div class="row g-3">

    <!--Details of Products, ADD to CARD, ADD to WISHLIST-->
    <div class="col-md-5 ps-3 col-lg-5 order-md-last p-0 order-1">
      <div class="d-grid gap-2">
        <div>
            <p class="h4">{{product.title}}</p>
            <p>Model: <span>{{product.model}}</span></p>
            <p>{{product.description}}</p>
            <p>Product Specification</p>
            <ul>
                {% for spec in product.specs.all %}
                    <p>{{spec.title}}: {{spec.content}}</p>
                {% endfor %}
            </ul>
               
        </div>

        <div class="d-flex d-flex-inline justify-content-between">
            <div class="price-wrap mt-1 h3">
                <span class="price">{{product.sale_price}} m</span>
                {% if product.on_sale %}
                <del class="price-old">${{product.price}}</del>
                {% endif %}
            </div>
        </div>
        <hr>
        {% if product_qty_in_cart > 0 %}
          <p>if product_qty_in_cart > 0, {{product_qty_in_cart}}</p>
          <button type="button" id="d-none-add-btn" value="{{product.id}}" class="btn btn-success fw500 d-none" hx-get="{% url "orders:add_to_cart" slug=product.slug %}"
            hx-trigger="click"
            hx-target="#cart-qty"
            hx-swap="outerHTML">
              Add to Cart
          </button>
          <div id="div-minus-plus" class="d-flex justify-content-around bg-primary rounded">
            <p class="cursor-pointer" hx-get="{% url "orders:remove_from_cart" slug=product.slug %}"
            hx-trigger="click"
            hx-target="#cart-qty"
            hx-swap="outerHTML"><i id="minus-btn" class="fa-solid fa-minus"></i></p>
            <p id="product-qty">{{ product_qty_in_cart }}</p>
            <p class="cursor-pointer" hx-get="{% url "orders:add_to_cart" slug=product.slug %}"
            hx-trigger="click"
            hx-target="#cart-qty"
            hx-swap="outerHTML"><i id="plus-btn" class="fa-solid fa-plus"></i></p> 
          </div>
        {% else %}
          <p>else</p>
          <button type="button" id="add-btn" value="{{product.id}}" class="btn btn-success fw500" hx-get="{% url "orders:add_to_cart" slug=product.slug %}"
          hx-trigger="click"
          hx-target="#cart-qty"
          hx-swap="outerHTML">
            Add to Cart
          </button>
          <div id="d-none-div" class="d-flex justify-content-around bg-primary rounded d-none">
            <p id="d-none-minus-btn" class="cursor-pointer"><i class="fa-solid fa-minus"></i></p>
            <p id="d-none-product-qty">{{ request.session.product_qty_in_cart|default:0 }}</p>
            <p id="d-none-plus-btn" class="cursor-pointer" hx-get="{% url "orders:add_to_cart" slug=product.slug %}"
            hx-trigger="click"
            hx-target="#cart-qty"
            hx-swap="outerHTML"><i class="fa-solid fa-plus"></i></p> 
          </div>
        {% endif %}
        <a href="#" class="btn btn-light fw500" role="button" aria-disabled="true">Add to Wish List</a>
      </div>
    </div>
    <!--END OF Details of Products, ADD to CARD, ADD to WISHLIST-->


    <!--Product Images-->
    <div class="col-md-7 col-lg-7 p-0">
      <div class="card mb-3 border-0 text-center">
        <div class="row g-0">
          <div class="col-md-12">

            <div class="card-body p-1">
              <h1 class="mb-0 h2 pe-4 pb-4">{{ product.title }}</h1>
              <div class="text-center">

                <img id="product-main-image" class="image-fluid mx-auto d-block" alt="Responsive image" src="{{ product.image.url}}"
                  alt="{{ product.title }}">
               
                {% for image in product.images.all %}
                <img id="{{image.id}}" class="other-images img-fluid d-block-inline pt-3" width="100px" alt="Responsive image"
                  src="{{ image.thumbnail.url }}" alt="{{ image.image.alt_text }}" 
                  hx-get="{% url "products:product_main_image" category_slug=product.category.slug slug=product.slug %}?product_id={{ product.id }}&image_id={{image.id}}"
                  hx-trigger="click"
                  hx-target="#product-main-image"
                  hx-swap="outerHTML">
                {% endfor %}
                <img id="{{image.id}}" class="other-images img-fluid d-block-inline pt-3" width="100px" alt="Responsive image"
                src="{{ product.image.url}}" alt="{{ product.title}}" 
                  hx-get="{% url "products:product_main_image" category_slug=product.category.slug slug=product.slug %}?product_id={{ product.id }}"
                  hx-trigger="click"
                  hx-target="#product-main-image"
                  hx-swap="outerHTML">
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>
    <!--END OF Product Images-->

  </div>

  {% endblock content %}


  {% block js %}
  <script>
    let itemsInCart = {{ request.session.cart_qty|default:0 }}
    let productQtyInCart = {{ product_qty_in_cart|default:0 }}
    console.log("itemsInCart =", itemsInCart)
    console.log("productQtyInCart =", productQtyInCart)

    const ifMoreDNoneAddBtn = document.querySelector('#d-none-add-btn')

    const ifMoreDivMinusPlus = document.querySelector('#div-minus-plus')
    const ifMoreMinusBtn = document.querySelector('#minus-btn')
    const ifMorePElemProductQty = document.querySelector('#product-qty')
    const ifMorePlusBtn = document.querySelector('#plus-btn')

    const elseAddBtn = document.querySelector('#add-btn')

    const elseDNoneDiv = document.querySelector('#d-none-div')
    const elseDNoneMinusBtn = document.querySelector('#d-none-minus-btn')
    const elseDNonePElemProductQty = document.querySelector('#d-none-product-qty')
    const elseDNonePlusBtn = document.querySelector('#d-none-plus-btn')


    console.log("elseAddBtn =", elseAddBtn)
    console.log("ifMoreMinusBtn =", ifMoreMinusBtn, "ifMorePElemProductQty =", ifMorePElemProductQty, "ifMorePlusBtn =", ifMorePlusBtn)
    console.log("elseDNoneDiv =", elseDNoneDiv)
    console.log("elseDNoneMinusBtn =", elseDNoneMinusBtn, "elseDNonePElemProductQty =", elseDNonePElemProductQty, "elseDNonePlusBtn =", elseDNonePlusBtn)

    document.querySelector("#product-detail-div").addEventListener('click', function(event) {
      var clickedElementId = event.target.id;
      console.log('You clicked on: ', clickedElementId);
    });

    function updateProductQtyInElement(e) {
      // Update the displayed product count
      e.textContent = productQtyInCart;
    };

    const addAndUpdateCartProducts = (eQtyToBeUpdated, eToAddDNone, eToRemoveDNone) => {
      updateProductQtyInElement(eQtyToBeUpdated);
      
      if (productQtyInCart > 0) {
        eToAddDNone.classList.add('d-none');
        eToRemoveDNone.classList.remove('d-none');
      }
    }

    const removeAndUpdateCartProducts = (eQtyToBeUpdated, eToAddDNone, eToRemoveDNone) => {
      updateProductQtyInElement(eQtyToBeUpdated);
      
      if (productQtyInCart === 0) {
        eToAddDNone.classList.add('d-none');
        eToRemoveDNone.classList.remove('d-none');
      }
    }
    
    // if {{ product_qty_in_cart|default:0 }} > 1
    ifMoreDNoneAddBtn.addEventListener("click", () => {
      // Increase the product count in cart
      productQtyInCart++;
      
      addAndUpdateCartProducts(
        eQtyToBeUpdated=ifMorePElemProductQty, 
        eToAddDNone=ifMoreDNoneAddBtn, 
        eToRemoveDNone=ifMoreDivMinusPlus
      )
    });

    ifMoreMinusBtn.addEventListener("click", () => {
      // Decrease the product count, but not below 0
      console.log("productQtyInCart =", productQtyInCart)
      productQtyInCart = Math.max(productQtyInCart - 1, 0);
      console.log("productQtyInCart =", productQtyInCart)


      removeAndUpdateCartProducts(
        eQtyToBeUpdated=ifMorePElemProductQty, 
        eToAddDNone=ifMoreDivMinusPlus, 
        eToRemoveDNone=ifMoreDNoneAddBtn
      )
    });

    ifMorePlusBtn.addEventListener("click", () => {
      // Increase the product count in cart
      productQtyInCart++;
      updateProductQtyInElement(ifMorePElemProductQty);
    });

    console.log("elseAddBtn =", elseAddBtn)
    // else; as if {{ product_qty_in_cart|default:0 }} < 1
    elseAddBtn.addEventListener("click", () => {
      // Increase the product count in cart
      console.log("productQtyInCart =", productQtyInCart)
      productQtyInCart++;
      console.log("productQtyInCart =", productQtyInCart)
      
      addAndUpdateCartProducts(
        eQtyToBeUpdated=elseDNonePElemProductQty, 
        eToAddDNone=elseAddBtn, 
        eToRemoveDNone=elseDNoneDiv
      )
      console.log("elseAddBtn =", elseAddBtn)
    });

    elseDNoneMinusBtn.addEventListener("click", () => {
      // Decrease the product count, but not below 0
      productQtyInCart = Math.max(productQtyInCart - 1, 0);
      
      removeAndUpdateCartProducts(
        eQtyToBeUpdated=elseDNonePElemProductQty, 
        eToAddDNone=elseDNoneDiv, 
        eToRemoveDNone=elseAddBtn
      )
    });

    elseDNonePlusBtn.addEventListener("click", () => {
      // Increase the product count in cart
      productQtyInCart++;
      updateProductQtyInElement(elseDNonePElemProductQty);
    });

    console.log("END OF SCRIPT")
  </script>
  {% endblock js %}



  <!--
    <img id="product-main-image" class="mx-auto d-block" alt="Responsive image" src="{{ product.image.url}}"
                  alt="{{ product.title }}">
               
    {% for image in product.images.all %}
    <img id="{{image.id}}" class="other-images img-fluid d-block-inline pt-3" width="100px" alt="Responsive image"
        src="{{ image.thumbnail.url }}" alt="{{ image.image.alt_text }}" 
        hx-get="{% url "products:product_main_image" slug=product.slug %}"
        hx-trigger="click"
        hx-target="#product-main-image"
        hx-swap="outerHTML"
        hx-include="[product_id='{{ product.id }}', image_id = '{{ image.id }}']">
    {% endfor %}
  -->