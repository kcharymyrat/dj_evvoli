{% extends 'base.html' %}

{% load static %}
{% load i18n %}


{% block title %}
{% if product %}{{ product.title }}{% else %}{% trans "Önüm" %}{% endif %}
{% endblock %}
{% block content %}

<div id="product-detail-div" class="container-xxl">
{% if messages %}
<div class="alert alert-warning" alert="{{ message.tags }}" role="alert">
{% for message in messages  %}
  {{message|safe}} - <a href="#" class="alert-link">Your Wishlist</a>.
{% endfor %}
</div>
{% endif %}
  <div class="row g-3">

    <!--Details of Products, ADD to CARD, ADD to WISHLIST-->
    <div class="col-md-5 ps-3 col-lg-5 order-md-last p-0 order-1">
      <div class="d-grid gap-2">
        <div>
            <p class="h4">{{product.title}}</p>
            <p>Model: <span>{{product.model}}</span></p>
            <p>{{product.description}}</p>
            <p>Product Specification</p>
            <ul>
                {% for spec in product.specs.all %}
                    <p>{{spec.title}}: {{spec.content}}</p>
                {% endfor %}
            </ul>
               
        </div>

        <div class="d-flex d-flex-inline justify-content-between">
            <div class="price-wrap mt-1 h3">
                <span class="price">{{product.sale_price}} m</span>
                {% if product.on_sale %}
                <del class="price-old">${{product.price}}</del>
                {% endif %}
            </div>
        </div>
        <hr>
          <button type="button" id="add-btn" value="{{product.id}}" 
          class="btn btn-success fw500
          {% if request.session.cart_qty > 0 %}d-none{% endif %}" 
          hx-get="{% url "orders:add_to_cart" slug=product.slug %}"
          hx-trigger="click"
          hx-target="#cart-qty"
          hx-swap="outerHTML">
            Add to Cart
          </button>
          <div id="d-none-div" 
          class="d-flex justify-content-around bg-primary rounded {% if request.session.cart_qty < 1 %}d-none{% endif %}">
            <p id="d-none-minus-btn" class="cursor-pointer" hx-get="{% url "orders:remove_from_cart" slug=product.slug %}"
            hx-trigger="click"
            hx-target="#cart-qty"
            hx-swap="outerHTML"><i class="fa-solid fa-minus"></i></p>
            <p id="d-none-product-qty">{{ product_qty_in_cart|default:0  }}</p>
            <p id="d-none-plus-btn" class="cursor-pointer" hx-get="{% url "orders:add_to_cart" slug=product.slug %}"
            hx-trigger="click"
            hx-target="#cart-qty"
            hx-swap="outerHTML"><i class="fa-solid fa-plus"></i></p> 
          </div>
        <a href="#" class="btn btn-light fw500" role="button" aria-disabled="true">Add to Wish List</a>
      </div>
    </div>
    <!--END OF Details of Products, ADD to CARD, ADD to WISHLIST-->


    <!--Product Images-->
    <div class="col-md-7 col-lg-7 p-0">
      <div class="card mb-3 border-0 text-center">
        <div class="row g-0">
          <div class="col-md-12">

            <div class="card-body p-1">
              <h1 class="mb-0 h2 pe-4 pb-4">{{ product.title }}</h1>
              <div class="text-center">

                <img id="product-main-image" class="image-fluid mx-auto d-block" alt="Responsive image" src="{{ product.image.url}}"
                  alt="{{ product.title }}">
               
                {% for image in product.images.all %}
                <img id="{{image.id}}" class="other-images img-fluid d-block-inline pt-3" width="100px" alt="Responsive image"
                  src="{{ image.thumbnail.url }}" alt="{{ image.image.alt_text }}" 
                  hx-get="{% url "products:product_main_image" category_slug=product.category.slug slug=product.slug %}?product_id={{ product.id }}&image_id={{image.id}}"
                  hx-trigger="click"
                  hx-target="#product-main-image"
                  hx-swap="outerHTML">
                {% endfor %}
                <img id="{{image.id}}" class="other-images img-fluid d-block-inline pt-3" width="100px" alt="Responsive image"
                src="{{ product.image.url}}" alt="{{ product.title}}" 
                  hx-get="{% url "products:product_main_image" category_slug=product.category.slug slug=product.slug %}?product_id={{ product.id }}"
                  hx-trigger="click"
                  hx-target="#product-main-image"
                  hx-swap="outerHTML">
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>
    <!--END OF Product Images-->

  </div>

  {% endblock content %}


  {% block js %}
  <script>
    let isClickable = true;
    const btnDisableTime = 500; // ms

    let itemsInCart = {{ request.session.cart_qty|default:0 }}
    let productQtyInCart = {{ product_qty_in_cart|default:0 }}
    console.log("itemsInCart =", itemsInCart)
    console.log("productQtyInCart =", productQtyInCart)

    const addBtn = document.querySelector('#add-btn')
    const dNoneDiv = document.querySelector('#d-none-div')
    const dNoneMinusBtn = document.querySelector('#d-none-minus-btn')
    const dNonePElemProductQty = document.querySelector('#d-none-product-qty')
    const dNonePlusBtn = document.querySelector('#d-none-plus-btn')

    console.log("addBtn =", addBtn)
    console.log("dNoneDiv =", dNoneDiv)
    console.log("dNoneMinusBtn =", dNoneMinusBtn, "dNonePElemProductQty =", dNonePElemProductQty, "dNonePlusBtn =", dNonePlusBtn)

    document.querySelector("#product-detail-div").addEventListener('click', function(event) {
      var clickedElementId = event.target.id;
      console.log('You clicked on: ', clickedElementId);
    });

    function updateProductQtyInElement(e) {
      // Update the displayed product count
      e.textContent = productQtyInCart;
    };

    const addAndUpdateCartProducts = (eQtyToBeUpdated, eToAddDNone, eToRemoveDNone) => {
      updateProductQtyInElement(eQtyToBeUpdated);
      
      if (productQtyInCart > 0) {
        eToAddDNone.classList.add('d-none');
        eToRemoveDNone.classList.remove('d-none');
      };
    };


    const removeAndUpdateCartProducts = (eQtyToBeUpdated, eToAddDNone, eToRemoveDNone) => {
      updateProductQtyInElement(eQtyToBeUpdated);
      
      if (productQtyInCart === 0) {
        eToAddDNone.classList.add('d-none');
        eToRemoveDNone.classList.remove('d-none');
      };
    };

    addBtn.addEventListener("click", () => {
      // Disable the button immediately after it's clicked
      addBtn.disabled = true;

      // Increase the product count in cart
      console.log("productQtyInCart =", productQtyInCart)
      productQtyInCart++;
      console.log("productQtyInCart =", productQtyInCart)
      
      addAndUpdateCartProducts(
        eQtyToBeUpdated=dNonePElemProductQty, 
        eToAddDNone=addBtn, 
        eToRemoveDNone=dNoneDiv
      )
      console.log("addBtn =", addBtn)

      // Re-enable the button after 1 second (or however long you want to wait)
      setTimeout(() => {
          addBtn.disabled = false;
      }, btnDisableTime); // ms
    });


    dNoneMinusBtn.addEventListener("click", () => {
      // Decrease the product count, but not below 0
      productQtyInCart = Math.max(productQtyInCart - 1, 0);

      dNoneMinusBtn.disabled = true;
      
      removeAndUpdateCartProducts(
        eQtyToBeUpdated=dNonePElemProductQty, 
        eToAddDNone=dNoneDiv, 
        eToRemoveDNone=addBtn
      )

      // Re-enable the button after 1 second (or however long you want to wait)
      setTimeout(() => {
        dNoneMinusBtn.disabled = false;
      }, btnDisableTime); // 1000 ms = 1 second
    });

    dNonePlusBtn.addEventListener("click", () => {
      // Increase the product count in cart
      productQtyInCart++;
      updateProductQtyInElement(dNonePElemProductQty);
      dNonePlusBtn.disabled = true;
      dNonePlusBtn.classList.add('d-none');
      setTimeout(() => {
        dNonePlusBtn.disabled = false;
      }, 3000); // 1000 ms = 1 second
      console.log("clicked");
      dNonePlusBtn.classList.remove('d-none');
    });

    console.log("END OF SCRIPT")
  </script>
  {% endblock js %}



  <!--
    <img id="product-main-image" class="mx-auto d-block" alt="Responsive image" src="{{ product.image.url}}"
                  alt="{{ product.title }}">
               
    {% for image in product.images.all %}
    <img id="{{image.id}}" class="other-images img-fluid d-block-inline pt-3" width="100px" alt="Responsive image"
        src="{{ image.thumbnail.url }}" alt="{{ image.image.alt_text }}" 
        hx-get="{% url "products:product_main_image" slug=product.slug %}"
        hx-trigger="click"
        hx-target="#product-main-image"
        hx-swap="outerHTML"
        hx-include="[product_id='{{ product.id }}', image_id = '{{ image.id }}']">
    {% endfor %}
  -->